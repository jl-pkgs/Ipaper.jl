# 计算anomaly的3种方法

```{julia}
using Ipaper
import Ipaper: cal_mTRS_base, cal_mTRS_season, cal_mTRS_full

dates = make_date(1961, 1, 1):Day(1):make_date(2022, 12, 31) |> collect
n = length(dates)
set_seed(1)

arr = rand(Float32, 35, 20, n)
obj_size(arr)

Threads.nthreads()
```

```{julia}
# 静态的阈值
# reset_timer!(to);
@time res = cal_mTRS_base(arr, dates; probs=[0.5], p1=1980, p2=2010, 
  use_mov=true, na_rm=true, parallel=true);
# to
# arr_anom1 = exceed(arr, TRS, dates)
```

```{julia}
# 动态的阈值，考虑未来的升温幅度，2种方案
# reset_timer!(to);
@time TRS_full = cal_mTRS_full(arr, dates; probs=[0.5], 
  na_rm=true, use_mov=true, parallel=true) |> squeeze;
obj_size(TRS_full)
# TRS_full[:, :, 1, :]
# arr_anom1 = exceed(arr, TRS, dates)
# _gt(x::T, y::T) where {T<:Real} = x > y
```

```{julia}
# 另外一种方法
@time clim_full = cal_climatology_full(arr, dates; 
  use_mov=true, parallel=true, fun=nanmedian);
obj_size(clim_full)
```
